#=================================================
# Description: Build OpenWrt using GitHub Actions
# License: MIT
# Author: Your Name
#=================================================

name: OpenWrt SSR

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt version to build'
        required: true
        default: 'master'
        type: choice
        options:
        - '23.05'
        - '24.10'
        - '25.12'
        - 'master'
      ssh:
        description: 'Enable SSH connection to Actions'
        required: false
        default: 'false'

env:
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  PASSWORD: ${{ secrets.PASSWORD }}
  REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
  REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
  DOCKER_ID: ${{ secrets.DOCKER_ID }}
  DOCKER_PASSWD: ${{ secrets.DOCKER_PASSWD }}
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    name: Build OpenWrt ${{ github.event.inputs.version }}
    strategy:
      fail-fast: false
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Clean workspace
      run: |
        # 清理可能存在的旧目录
        rm -rf openwrt
        echo "Cleaned workspace"

    - name: Free disk space
      uses: coder-xiaomo/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
        python3-setuptools rsync swig unzip zlib1g-dev file wget scdoc \
        llvm python3-pyelftools libpython3-dev aria2 jq qemu-utils ccache rename \
        libelf-dev device-tree-compiler libgmp3-dev libmpc-dev libfuse-dev \
        liblzma-dev libcurl4-openssl-dev libsqlite3-dev libxml2-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "Asia/Shanghai"
        # 清理系统残留的Rust环境，避免和OpenWrt内置构建冲突
        rm -rf ~/.cargo ~/.rustup /usr/local/cargo /usr/local/rustup

    - name: Get current date
      id: date
      run: |
        echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
        echo "date2=$(date +'%m/%d %Y')" >> $GITHUB_ENV
        echo "date3=$(date +'%m.%d')" >> $GITHUB_ENV
        echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV

    # 【修改1】缓存步骤提前到克隆源码前，让缓存先生效，且排除Rust相关缓存（避免缓存有问题的文件）
    - name: Cache OpenWrt build files
      uses: actions/cache@v3
      with:
        path: |
          ./openwrt/dl
          ./openwrt/staging_dir/host
          ./openwrt/staging_dir/toolchain-*
          ~/.ccache
        key: ${{ runner.os }}-openwrt-${{ github.event.inputs.version }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ github.event.inputs.version }}-

    - name: Clone OpenWrt official source code
      run: |
        # 清理可能存在的旧目录
        rm -rf openwrt
        
        # Determine branch/tag based on version selection
        if [[ "${{ github.event.inputs.version }}" == "master" ]]; then
          REPO_BRANCH="master"
        elif [[ "${{ github.event.inputs.version }}" == "23.05" ]]; then
          REPO_BRANCH="openwrt-23.05"
        elif [[ "${{ github.event.inputs.version }}" == "24.10" ]]; then
          REPO_BRANCH="openwrt-24.10"
        elif [[ "${{ github.event.inputs.version }}" == "25.12" ]]; then
          REPO_BRANCH="openwrt-25.12"
        fi
        
        echo "Cloning OpenWrt branch: $REPO_BRANCH"
        git clone --depth 1 https://github.com/openwrt/openwrt.git -b "$REPO_BRANCH" openwrt
        cd openwrt
        
        # Add helloworld plugin source
        echo 'src-git helloworld https://github.com/fw876/helloworld.git' >> feeds.conf.default
        
        # Update feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Free up disk space (mount dl/staging)
      run: |
        sudo mkdir -p -m 777 /mnt/openwrt/dl /mnt/openwrt/staging_dir
        ln -sf /mnt/openwrt/dl openwrt/dl
        ln -sf /mnt/openwrt/staging_dir openwrt/staging_dir

    # 【修改2】彻底禁用Rust及相关包，提前写入（在生成.config前，锁定配置不被还原）
    - name: Write Rust disable config (local.mk) - 核心禁用
      working-directory: ./openwrt
      run: |
        echo "# 彻底禁用所有Rust相关构建（Host端+目标端）" > local.mk
        echo "CONFIG_RUST=n" >> local.mk
        echo "CONFIG_RUST_HOST_DEPENDENCIES=n" >> local.mk
        echo "CONFIG_RUST_HOST_DEPENDENCIES_USE_SYSTEM=n" >> local.mk
        echo "CONFIG_RUST_DOWNLOAD_CI_LLVM=n" >> local.mk
        echo "CONFIG_RUST_CARGO=n" >> local.mk
        echo "CONFIG_RUST_RUSTC=n" >> local.mk
        echo "CONFIG_RUST_RUSTFMT=n" >> local.mk
        echo "# 禁用不必要的专利包，减少编译量" >> local.mk
        echo "CONFIG_BUILD_PATENTED=n" >> local.mk
        echo "# 禁用可能导致构建失败的包" >> local.mk
        echo "CONFIG_PACKAGE_rust=y" >> local.mk
        echo "CONFIG_PACKAGE_rustc=y" >> local.mk
        echo "CONFIG_PACKAGE_cargo=y" >> local.mk
        # 清理可能残留的Rust配置文件
        rm -rf .config* package/feeds/packages/rust/.built package/feeds/packages/rust/Makefile.old

    # 【修改3】加载默认配置（x86_64），确保至少有一个基本配置可以编译
    - name: Load default configuration
      working-directory: ./openwrt
      run: |
        # 检查可用的目标架构
        echo "Available targets:"
        ls target/linux/
        
        # 更新feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 生成x86_64默认配置
        make defconfig
        make x86/64_defconfig

    # 【修改4】设置自定义配置，启用必要的包和目标，彻底禁用Rust相关包
    - name: Set custom configuration
      working-directory: ./openwrt
      run: |
        # 检查是否有自定义配置文件，如果没有则使用默认配置
        if [ -f ../.config ]; then
            cp ../.config .config
        else
            # 创建一个基本配置，确保能生成固件
            make x86/64_defconfig
        fi
        
        # 确保启用了基本的镜像生成选项
        sed -i 's/CONFIG_TARGET_ROOTFS_CPIOGZ=.*/# CONFIG_TARGET_ROOTFS_CPIOGZ is not set/g' .config
        sed -i 's/CONFIG_TARGET_ROOTFS_TARGZ=.*/# CONFIG_TARGET_ROOTFS_TARGZ is not set/g' .config
        sed -i '/CONFIG_TARGET_ROOTFS_EXT4FS/d' .config
        echo 'CONFIG_TARGET_ROOTFS_SQUASHFS=y' >> .config
        echo 'CONFIG_TARGET_IMAGES_GZIP=y' >> .config
        
        # 确保启用了基本的网络工具
        echo 'CONFIG_PACKAGE_curl=y' >> .config
        echo 'CONFIG_PACKAGE_wget=y' >> .config
        echo 'CONFIG_PACKAGE_luci=y' >> .config
        echo 'CONFIG_PACKAGE_luci-theme-bootstrap=y' >> .config
        echo 'CONFIG_PACKAGE_luci-app-opkg=y' >> .config
        
        # 启用helloworld插件
        echo 'CONFIG_PACKAGE_luci-app-ssr-plus=y' >> .config
        
        # 彻底禁用Rust相关包（关键修复）
        echo '# CONFIG_PACKAGE_rust is not set' >> .config
        echo '# CONFIG_PACKAGE_rustc is not set' >> .config
        echo '# CONFIG_PACKAGE_cargo is not set' >> .config
        echo '# CONFIG_PACKAGE_rust-musl is not set' >> .config
        echo '# CONFIG_PACKAGE_rustc-musl is not set' >> .config
        echo '# CONFIG_PACKAGE_cargo-musl is not set' >> .config
        echo 'CONFIG_RUST=n' >> .config
        echo 'CONFIG_RUST_HOST_DEPENDENCIES=n' >> .config
        echo '# CONFIG_RUST_CARGO is not set' >> .config
        echo '# CONFIG_RUST_RUSTC is not set' >> .config
        echo '# CONFIG_RUST_RUSTDOC is not set' >> .config
        echo '# CONFIG_RUST_RUSTFMT is not set' >> .config
        echo '# CONFIG_RUST_CLIPPY is not set' >> .config
        
        # 禁用其他可能导致构建失败的包
        echo '# CONFIG_PACKAGE_rust-std-aarch64 is not set' >> .config
        echo '# CONFIG_PACKAGE_rust-std-arm is not set' >> .config
        echo '# CONFIG_PACKAGE_rust-std-i686 is not set' >> .config
        echo '# CONFIG_PACKAGE_rust-std-x86_64 is not set' >> .config
        
        # 重新生成配置
        make defconfig
        
        # 显示最终配置概要
        echo "Final configuration summary:"
        grep "CONFIG_TARGET" .config | head -10
        grep -E "(CONFIG_RUST|CONFIG_PACKAGE_rust)" .config || echo "No rust configs found"
        grep "CONFIG_PACKAGE_luci-app-ssr-plus" .config || echo "luci-app-ssr-plus not enabled"
        grep "CONFIG_TARGET_ROOTFS_SQUASHFS" .config || echo "SQUASHFS not enabled"

    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: github.event.inputs.ssh == 'true'
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Download package (skip Rust)
      working-directory: ./openwrt
      run: |
        echo "Starting package download..."
        # 禁用Rust相关下载，加速下载
        export SKIP_RUST=1
        make download -j$(nproc) V=s || make download -j1 V=s
        # 清理空文件，避免编译报错
        find dl -size -1024c -exec rm -f {} \;
        # 额外清理Rust相关下载文件（如果有）
        rm -rf dl/rust* dl/cargo* dl/llvm*ci*
        echo "✅ Package download completed (Rust files cleaned)"

    - name: Prepare for compilation
      working-directory: ./openwrt
      run: |
        # 检查配置是否有效
        echo "Validating configuration..."
        if [ ! -f ".config" ]; then
          echo "❌ Configuration file (.config) not found!"
          exit 1
        fi
        
        # 检查是否有有效的目标架构
        if ! grep -q "CONFIG_TARGET.*=y" .config; then
          echo "❌ No valid target architecture configured!"
          echo "Available targets:"
          ls target/linux/
          exit 1
        fi
        
        # 检查Rust是否被正确禁用
        if grep -q "CONFIG_PACKAGE_rust=y\|CONFIG_RUST=y" .config; then
          echo "❌ Warning: Rust packages are still enabled in config!"
          grep -E "(CONFIG_RUST|CONFIG_PACKAGE_rust)" .config
        else
          echo "✅ Rust packages are properly disabled"
        fi
        
        echo "✅ Configuration validation passed"

    - name: Compile the firmware
      working-directory: ./openwrt
      run: |
        export CC=clang
        export CXX=clang++
        export MAKEFLAGS="-j$(($(nproc)+1))"
        
        # 显示当前配置信息
        echo "Current configuration summary:"
        grep "CONFIG_TARGET.*=y" .config | head -5
        echo "Rust configuration:"
        grep -E "(CONFIG_RUST|CONFIG_PACKAGE_rust)" .config || echo "No rust configs found"
        
        # 开始编译
        echo "Starting compilation..."
        make V=s IGNORE_ERRORS=1 2>&1 | tee build.log
        
        # 检查编译状态 - 允许某些包失败但整体成功
        if [ ${PIPESTATUS[0]} -ne 0 ]; then
          echo "⚠️ 编译过程遇到错误，但继续检查是否生成了固件"
          # 检查是否有关键错误
          if grep -q "package.*failed to build" build.log && ! grep -q "rust.*failed" build.log; then
            echo "❌ 存在非Rust相关的关键错误"
            tail -50 build.log
            exit 1
          else
            echo "✅ 编译完成（可能有非关键错误，但不影响固件生成）"
          fi
        else
          echo "✅ 编译成功"
        fi

    - name: Check build results
      working-directory: ./openwrt
      run: |
        echo "Checking build output directories..."
        echo "Contents of bin/:"
        find bin/ -type f -name "*.img*" -o -name "*.bin" -o -name "*.gz" | head -20
        echo "Total image files found:"
        find bin/ -type f -name "*.img*" -o -name "*.bin" -o -name "*.gz" | wc -l
        
        echo "All files in bin/:"
        find bin/ -type f | head -30
        echo "All directories in bin/:"
        find bin/ -type d | head -10
        
        # 检查是否真的生成了固件
        if [ ! -d "bin/" ]; then
          echo "❌ 错误：bin/ 目录不存在"
          exit 1
        fi
        
        # 检查是否生成了镜像文件
        IMAGE_COUNT=$(find bin/ -type f -name "*.img*" -o -name "*.bin" | wc -l)
        if [ "$IMAGE_COUNT" -eq 0 ]; then
          echo "❌ 警告：没有找到固件镜像文件，但编译似乎已完成"
          echo "检查build.log中的错误信息："
          tail -100 build.log
          # 即使没有镜像文件也要继续，因为可能是配置问题
        else
          echo "✅ 发现 $IMAGE_COUNT 个固件文件"
        fi

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        mkdir -p firmware
        echo "Created firmware directory"
        
        # 检查bin目录是否存在
        if [ ! -d "openwrt/bin" ]; then
          echo "❌ 错误：openwrt/bin 目录不存在"
          ls -la
          pwd
          exit 1
        fi
        
        # 尝试多种方式查找固件文件
        echo "Searching for firmware files..."
        
        # 方法1: 在targets子目录中查找
        if [ -d "openwrt/bin/targets" ]; then
          echo "Looking in targets directory..."
          find openwrt/bin/targets -type f \( -name "*.img*" -o -name "*.bin" -o -name "*.gz" \) -print
          find openwrt/bin/targets -type f \( -name "*.img*" -o -name "*.bin" -o -name "*.gz" \) -exec cp {} firmware/ \; || echo "No firmware files found in targets"
        else
          echo "No targets directory found"
        fi
        
        # 方法2: 在整个bin目录中查找
        echo "Looking in entire bin directory..."
        find openwrt/bin -type f \( -name "*.img*" -o -name "*.bin" -o -name "*.gz" \) -not -path "*/targets/*" -print
        find openwrt/bin -type f \( -name "*.img*" -o -name "*.bin" -o -name "*.gz" \) -not -path "*/targets/*" -exec cp {} firmware/ \; || echo "No firmware files found in other bin subdirectories"
        
        # 方法3: 如果还没有找到，查找所有可能的固件文件
        if [ -z "$(ls -A firmware 2>/dev/null)" ]; then
          echo "Still no firmware files found, trying broader search..."
          find openwrt/bin -type f -name "*combined*" -o -name "*sysupgrade*" -o -name "*factory*" -o -name "*squashfs*" -print
          find openwrt/bin -type f -name "*combined*" -o -name "*sysupgrade*" -o -name "*factory*" -o -name "*squashfs*" -exec cp {} firmware/ \; || echo "No firmware files found with extended pattern"
        fi
        
        # 方法4: 如果仍然没有找到，至少复制一些有用的构建文件
        if [ -z "$(ls -A firmware 2>/dev/null)" ]; then
          echo "No firmware files found, copying build logs instead..."
          mkdir -p firmware/logs
          cp openwrt/build.log firmware/logs/ || echo "No build log to copy"
          cp openwrt/.config firmware/config 2>/dev/null || echo "No config to copy"
          
          # 创建一个说明文件
          cat > firmware/README.txt << EOF
          #编译完成，但未找到固件镜像文件。

         # 可能的原因：
         # 1. 编译过程未完成
         # 2. 配置不正确，未启用镜像生成
          #3. 目标架构不匹配
         # 4. 编译过程遇到错误但未中断

         # 请检查build.log了解详细信息。
          EOF
                  fi
        
        # 复制配置和构建信息
        cp openwrt/.config firmware/openwrt.config 2>/dev/null || echo "No config file to copy"
        echo "Build date: $(date +'%Y-%m-%d %H:%M:%S')" > firmware/build-info.txt
        echo "OpenWrt version: ${{ github.event.inputs.version }}" >> firmware/build-info.txt
        echo "Helloworld plugin: https://github.com/fw876/helloworld" >> firmware/build-info.txt
        echo "Build log:" >> firmware/build-info.txt
        tail -50 openwrt/build.log >> firmware/build-info.txt 2>/dev/null || echo "No build log available"
        
        # 生成MD5
        cd firmware
        for file in *; do
          [ -f "$file" ] && [[ ! "$file" =~ \.(md5|txt|config)$ ]] && md5sum "$file" > "$file.md5"
        done
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT
        
        # 列出找到的固件文件
        echo "Files in firmware directory:"
        ls -la firmware/
        
        # 不再退出，即使没有找到固件文件，因为这可能是配置问题而不是脚本问题
        echo "✅ Firmware organization completed"

    - name: Upload firmware directory
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_${{ github.event.inputs.version }}_${{ env.date }}
        path: ${{ env.FIRMWARE }}

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=${{ github.event.inputs.version }}-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: OpenWrt ${{ github.event.inputs.version }} Build ${{ env.date }}
        body: |
          ### OpenWrt ${{ github.event.inputs.version }} 构建固件
          - 构建时间：${{ env.date2 }} ${{ env.date3 }}
          - 核心插件：helloworld (fw876)
          - 源码：[openwrt/openwrt](https://github.com/openwrt/openwrt)
          - 编译环境：GitHub Actions Ubuntu 22.04
          - 已彻底禁用Rust编译，解决host-rustc构建失败问题
        files: ${{ env.FIRMWARE }}/*

    - name: Delete workflow runs
      uses: glmghost/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.2.1
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
