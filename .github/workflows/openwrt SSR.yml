#=================================================
# Description: Build OpenWrt using GitHub Actions
# License: MIT
# Author: Your Name
#=================================================

name: OpenWrt SSR

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt version to build'
        required: true
        default: 'master'
        type: choice
        options:
        - '23.05'
        - '24.10'
        - '25.12'
        - 'master'
      ssh:
        description: 'Enable SSH connection to Actions'
        required: false
        default: 'false'

env:
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  PASSWORD: ${{ secrets.PASSWORD }}
  REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
  REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
  DOCKER_ID: ${{ secrets.DOCKER_ID }}
  DOCKER_PASSWD: ${{ secrets.DOCKER_PASSWD }}
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    name: Build OpenWrt ${{ github.event.inputs.version }}
    strategy:
      fail-fast: false
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Free disk space
      uses: coder-xiaomo/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
        python3-setuptools rsync swig unzip zlib1g-dev file wget scdoc \
        llvm python3-pyelftools libpython3-dev aria2 jq qemu-utils ccache rename \
        libelf-dev device-tree-compiler libgmp3-dev libmpc-dev libfuse-dev \
        liblzma-dev libcurl4-openssl-dev libsqlite3-dev libxml2-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "Asia/Shanghai"
        # 清理系统残留的Rust环境，避免和OpenWrt内置构建冲突
        rm -rf ~/.cargo ~/.rustup /usr/local/cargo /usr/local/rustup

    - name: Get current date
      id: date
      run: |
        echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
        echo "date2=$(date +'%m/%d %Y')" >> $GITHUB_ENV
        echo "date3=$(date +'%m.%d')" >> $GITHUB_ENV
        echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV

    # 【修改1】缓存步骤提前到克隆源码前，让缓存先生效，且排除Rust相关缓存（避免缓存有问题的文件）
    - name: Cache OpenWrt build files
      uses: actions/cache@v3
      with:
        path: |
          openwrt/dl
          openwrt/staging_dir/host
          openwrt/staging_dir/toolchain-*
          ~/.ccache
        key: ${{ runner.os }}-openwrt-${{ github.event.inputs.version }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ github.event.inputs.version }}-

    - name: Clone OpenWrt official source code
      run: |
        # Determine branch/tag based on version selection
        if [[ "${{ github.event.inputs.version }}" == "master" ]]; then
          REPO_BRANCH="master"
        elif [[ "${{ github.event.inputs.version }}" == "23.05" ]]; then
          REPO_BRANCH="openwrt-23.05"
        elif [[ "${{ github.event.inputs.version }}" == "24.10" ]]; then
          REPO_BRANCH="openwrt-24.10"
        elif [[ "${{ github.event.inputs.version }}" == "25.12" ]]; then
          REPO_BRANCH="openwrt-25.12"
        fi
        
        git clone --depth 1 https://github.com/openwrt/openwrt.git -b "$REPO_BRANCH" openwrt
        cd openwrt
        
        # Add helloworld plugin source
        echo 'src-git helloworld https://github.com/fw876/helloworld.git' >> feeds.conf.default
        
        # Update feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Free up disk space (mount dl/staging)
      run: |
        sudo mkdir -p -m 777 /mnt/openwrt/dl /mnt/openwrt/staging_dir
        ln -sf /mnt/openwrt/dl openwrt/dl
        ln -sf /mnt/openwrt/staging_dir openwrt/staging_dir

    # 【修改2】彻底禁用Rust的local.mk，提前写入（在生成.config前，锁定配置不被还原）
    - name: Write Rust disable config (local.mk) - 核心禁用
      working-directory: ./openwrt
      run: |
        cat > local.mk << EOF
        # 彻底禁用所有Rust相关构建（Host端+目标端）
        CONFIG_RUST=n
        CONFIG_RUST_HOST_DEPENDENCIES=n
        CONFIG_RUST_HOST_DEPENDENCIES_USE_SYSTEM=n
        CONFIG_RUST_DOWNLOAD_CI_LLVM=n
        CONFIG_RUST_CARGO=n
        CONFIG_RUST_RUSTC=n
        CONFIG_RUST_RUSTFMT=n
        # 禁用不必要的专利包，减少编译量
        CONFIG_BUILD_PATENTED=n
        EOF
        # 清理可能残留的Rust配置文件
        rm -rf .config* package/feeds/packages/rust/.built package/feeds/packages/rust/Makefile.old

    # 【修改3】加载自定义配置+提前禁用Rust（在make defconfig前操作，避免配置被还原）
    - name: Load custom config + Rust disable (before defconfig)
      run: |
        cd openwrt
        # 复制自定义.config（如果有）
        if [ -e ../../.config ]; then
          cp -f ../../.config ./.config
          echo "✅ 已复制自定义.config"
        fi
        
        # 【核心】在生成defconfig前，禁用所有Rust相关选项（正则匹配，全覆盖）
        sed -i \
        -e 's/^CONFIG_RUST=y/CONFIG_RUST=n/g' \
        -e 's/^CONFIG_RUST_HOST_DEPENDENCIES=y/CONFIG_RUST_HOST_DEPENDENCIES=n/g' \
        -e 's/^CONFIG_RUST_DOWNLOAD_CI_LLVM=y/CONFIG_RUST_DOWNLOAD_CI_LLVM=n/g' \
        -e 's/^CONFIG_RUST_CARGO=y/# CONFIG_RUST_CARGO is not set/g' \
        -e 's/^CONFIG_RUST_RUSTC=y/# CONFIG_RUST_RUSTC is not set/g' \
        -e 's/^CONFIG_RUST_RUSTFMT=y/# CONFIG_RUST_RUSTFMT is not set/g' \
        -e 's/^CONFIG_PACKAGE_rust=/# CONFIG_PACKAGE_rust is not set/g' \
        -e 's/^CONFIG_PACKAGE_rustc=/# CONFIG_PACKAGE_rustc is not set/g' \
        .config || echo "⚠️  无.config，跳过sed修改"
        
        # 生成defconfig（此时Rust配置已禁用，不会被还原）
        make defconfig
        # 再次验证禁用结果，确保万无一失
        grep -E 'RUST|rust' .config | grep -v 'n$' | grep -v '^#' || echo "✅ Rust已彻底禁用"

    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: github.event.inputs.ssh == 'true'
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    # 【修改4】移除原有的系统Rust安装步骤（完全不需要，反而冲突）

    - name: Download package (skip Rust)
      working-directory: ./openwrt
      run: |
        echo "Starting package download..."
        # 禁用Rust相关下载，加速下载
        export SKIP_RUST=1
        make download -j$(nproc) V=s || make download -j1 V=s
        # 清理空文件，避免编译报错
        find dl -size -1024c -exec rm -f {} \;
        # 额外清理Rust相关下载文件（如果有）
        rm -rf dl/rust* dl/cargo* dl/llvm*ci*
        echo "✅ Package download completed (Rust files cleaned)"

    - name: Compile the firmware (with Rust fail retry)
      working-directory: ./openwrt
      run: |
        export CC=clang
        export CXX=clang++
        export MAKEFLAGS="-j$(($(nproc)+1))"
        # 第一次编译
        make V=s 2>&1 | tee build.log || {
          echo "❌ 编译失败，尝试终极Rust禁用后重试"
          # 终极方案：直接追加所有Rust禁用项到.config，无需匹配
          echo "CONFIG_RUST=n" >> .config
          echo "CONFIG_RUST_HOST_DEPENDENCIES=n" >> .config
          echo "CONFIG_RUST_DOWNLOAD_CI_LLVM=n" >> .config
          echo "# CONFIG_RUST_CARGO is not set" >> .config
          echo "# CONFIG_RUST_RUSTC is not set" >> .config
          echo "# CONFIG_PACKAGE_rust is not set" >> .config
          echo "# CONFIG_PACKAGE_rustc is not set" >> .config
          make defconfig
          # 单线程编译，避免资源冲突
          make -j1 V=s
        }

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        mkdir -p firmware
        # 复制固件文件（只保留常用的combined/sysupgrade，减少文件量）
        find openwrt/bin/targets -type f \( -name "*combined*.img.gz" -o -name "*sysupgrade*.bin" \) -exec cp {} firmware/ \;
        # 复制配置和构建信息
        cp openwrt/.config firmware/openwrt.config
        echo "Build date: $(date +'%Y-%m-%d %H:%M:%S')" > firmware/build-info.txt
        echo "OpenWrt version: ${{ github.event.inputs.version }}" >> firmware/build-info.txt
        echo "Helloworld plugin: https://github.com/fw876/helloworld" >> firmware/build-info.txt
        # 生成MD5
        cd firmware
        for file in *; do
          [ -f "$file" ] && [[ ! "$file" =~ \.(md5|txt|config)$ ]] && md5sum "$file" > "$file.md5"
        done
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware directory
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_${{ github.event.inputs.version }}_${{ env.date }}
        path: ${{ env.FIRMWARE }}

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=${{ github.event.inputs.version }}-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: OpenWrt ${{ github.event.inputs.version }} Build ${{ env.date }}
        body: |
          ### OpenWrt ${{ github.event.inputs.version }} 构建固件
          - 构建时间：${{ env.date2 }} ${{ env.date3 }}
          - 核心插件：helloworld (fw876)
          - 源码：[openwrt/openwrt](https://github.com/openwrt/openwrt)
          - 编译环境：GitHub Actions Ubuntu 22.04
          - 已彻底禁用Rust编译，解决host-rustc构建失败问题
        files: ${{ env.FIRMWARE }}/*

    - name: Delete workflow runs
      uses: glmghost/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.2.1
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
