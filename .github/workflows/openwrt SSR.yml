#=================================================
# Description: Build OpenWrt using GitHub Actions
# License: MIT
# Author: Your Name
#=================================================

name: OpenWrt SSR

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt version to build'
        required: true
        default: 'master'
        type: choice
        options:
        - '23.05'
        - '24.10'
        - '25.12'
        - 'master'
      ssh:
        description: 'Enable SSH connection to Actions'
        required: false
        default: 'false'

env:
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  PASSWORD: ${{ secrets.PASSWORD }}
  REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
  REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
  DOCKER_ID: ${{ secrets.DOCKER_ID }}
  DOCKER_PASSWD: ${{ secrets.DOCKER_PASSWD }}
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    name: Build OpenWrt ${{ github.event.inputs.version }}
    strategy:
      fail-fast: false
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Free disk space
      uses: coder-xiaomo/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential clang flex bison g++ gawk \
        gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
        python3-setuptools rsync swig unzip zlib1g-dev file wget scdoc \
        llvm python3-pyelftools libpython3-dev aria2 jq qemu-utils ccache rename \
        libelf-dev device-tree-compiler libgmp3-dev libmpc-dev libfuse-dev \
        liblzma-dev libcurl4-openssl-dev libsqlite3-dev libxml2-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "Asia/Shanghai"

    - name: Install Rust toolchain
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        rustc --version
        cargo --version

    - name: Get current date
      id: date
      run: |
        echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
        echo "date2=$(date +'%m/%d %Y')" >> $GITHUB_ENV
        echo "date3=$(date +'%m.%d')" >> $GITHUB_ENV
        echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV

    - name: Clone OpenWrt official source code
      run: |
        # Determine branch/tag based on version selection
        if [[ "${{ github.event.inputs.version }}" == "master" ]]; then
          REPO_BRANCH="master"
        elif [[ "${{ github.event.inputs.version }}" == "23.05" ]]; then
          REPO_BRANCH="openwrt-23.05"
        elif [[ "${{ github.event.inputs.version }}" == "24.10" ]]; then
          REPO_BRANCH="openwrt-24.10"
        elif [[ "${{ github.event.inputs.version }}" == "25.12" ]]; then
          REPO_BRANCH="openwrt-25.12"
        fi
        
        if [[ -n "$REPO_TAG" ]]; then
          git clone --depth 1 https://github.com/openwrt/openwrt.git -b "$REPO_TAG" openwrt
        else
          git clone --depth 1 https://github.com/openwrt/openwrt.git -b "$REPO_BRANCH" openwrt
        fi
        
        cd openwrt
        
        # Add helloworld plugin source
        echo 'src-git helloworld https://github.com/fw876/helloworld.git' >> feeds.conf.default
        
        # Update feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Free up disk space
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo mkdir -p -m 777 /mnt/openwrt/dl /mnt/openwrt/staging_dir
        ln -sf /mnt/openwrt/dl openwrt/dl
        ln -sf /mnt/openwrt/staging_dir openwrt/staging_dir

    - name: Configure Rust for CI
      working-directory: ./openwrt
      run: |
        # Create necessary directories if they don't exist
        mkdir -p .cargo
        
        # Create config override to fix Rust LLVM issue in CI
        echo "# Rust configuration override for CI" > .cargo/config.toml
        echo "[build]" >> .cargo/config.toml
        echo "rustflags = [\"-C\", \"link-arg=-fuse-ld=lld\"]" >> .cargo/config.toml
        
        # Additionally, create local.mk to disable Rust compilation if needed
        echo "# Local Makefile overrides" > local.mk
        echo "# Disable Rust packages to avoid CI LLVM issue" >> local.mk
        echo "CONFIG_RUST_HOST_DEPENDENCIES=n" >> local.mk
        echo "CONFIG_RUST_HOST_DEPENDENCIES_USE_SYSTEM=y" >> local.mk
        echo "CONFIG_RUST_HOST_DEPENDENCIES_CARGO_REGISTRY_MIRROR=\"https://crates.io\"" >> local.mk
        echo "CONFIG_RUST_HOST_DEPENDENCIES_CARGO_ALTERNATE_REGISTRIES=\"\"" >> local.mk

    - name: Load custom configuration
      run: |
        echo "当前工作目录：$(pwd)"
        
        # 处理自定义配置
        if [ -e ./.config ]; then
          echo "✅ 找到项目根目录下的.config文件，准备同步到openwrt编译目录"
          cp -f ./.config ./openwrt/.config
          echo "✅ 已成功将项目根目录.config复制到 ./openwrt/.config"
        else
          echo "⚠️  警告：项目根目录下未找到.config文件，将使用openwrt目录默认配置"
        fi

        if [ -d ./files ]; then
          echo "✅ 找到项目根目录下的files目录，准备移动到openwrt目录"
          cp -rf ./files ./openwrt/files
          echo "✅ 已成功将项目根目录files目录复制到 ./openwrt/files"
        fi

        # 进入openwrt目录，配置helloworld插件
        cd ./openwrt
        
        # 确保配置了helloworld源
        if ! grep -q "helloworld" feeds.conf.default; then
          echo 'src-git helloworld https://github.com/fw876/helloworld.git' >> feeds.conf.default
        fi
        
        # 更新并安装feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 如果已有.config，则应用配置
        if [ -e ./.config ]; then
          echo "✅ 验证openwrt目录下的.config配置，自动补全缺失项"
          
          # 尝试修复配置中的Rust相关问题
          sed -i 's/CONFIG_RUST_DOWNLOAD_CI_LLVM=y/CONFIG_RUST_DOWNLOAD_CI_LLVM=if-unchanged/g' .config
          sed -i 's/CONFIG_RUST_HOST_DEPENDENCIES=y/CONFIG_RUST_HOST_DEPENDENCIES=n/g' .config
          sed -i 's/CONFIG_RUST_HOST_DEPENDENCIES_USE_SYSTEM=n/CONFIG_RUST_HOST_DEPENDENCIES_USE_SYSTEM=y/g' .config
          
          # 如果配置文件中启用了Rust包，尝试禁用以避免CI问题
          sed -i 's/CONFIG_PACKAGE_rust=y/# CONFIG_PACKAGE_rust is not set/g' .config
          
          # 禁用所有Rust相关包
          sed -i 's/CONFIG_PACKAGE_rustc=y/# CONFIG_PACKAGE_rustc is not set/g' .config
          sed -i 's/CONFIG_PACKAGE_rustfmt=y/# CONFIG_PACKAGE_rustfmt is not set/g' .config
          sed -i 's/CONFIG_PACKAGE_cargo=y/# CONFIG_PACKAGE_cargo is not set/g' .config
          
          make defconfig
          echo "✅ 配置验证完成"
        else
          # 生成默认配置
          make defconfig
          # 应用Rust相关配置
          sed -i 's/CONFIG_RUST_HOST_DEPENDENCIES=y/CONFIG_RUST_HOST_DEPENDENCIES=n/g' .config
          sed -i 's/CONFIG_RUST_HOST_DEPENDENCIES_USE_SYSTEM=n/CONFIG_RUST_HOST_DEPENDENCIES_USE_SYSTEM=y/g' .config
          make defconfig
          echo "ℹ️  使用默认配置，并已禁用Rust host构建"
        fi

    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: github.event.inputs.ssh == 'true'
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Setup Rust environment variables
      working-directory: ./openwrt
      run: |
        # 设置Rust环境变量
        export CARGO_HOME="$HOME/.cargo"
        export RUSTUP_HOME="$HOME/.rustup"
        export PATH="$CARGO_HOME/bin:$PATH"
        
        # 设置Rust镜像源（可选，如果需要加速）
        # echo "[source.crates-io]" > $CARGO_HOME/config
        # echo "replace-with = 'tuna'" >> $CARGO_HOME/config
        # echo "[source.tuna]" >> $CARGO_HOME/config
        # echo "registry = \"https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git\"" >> $CARGO_HOME/config
        
        # 验证Rust安装
        rustc --version
        cargo --version

    - name: Download package
      working-directory: ./openwrt
      run: |
        echo "Starting package download..."
        # 设置环境变量以避免Rust下载问题
        export CARGO_HOME="$HOME/.cargo"
        export RUSTUP_HOME="$HOME/.rustup"
        export PATH="$CARGO_HOME/bin:$PATH"
        
        make download -j$(nproc) V=s || make download -j1 V=s
        find dl -size -1024c -exec rm -f {} \;
        echo "Package download completed."

    - name: Cache
      uses: actions/cache@v3
      with:
        path: |
          openwrt/dl
          openwrt/staging_dir
          ~/.ccache
          ~/.cargo
          ~/.rustup
        key: ${{ runner.os }}-openwrt-${{ github.event.inputs.version }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ github.event.inputs.version }}-

    - name: Compile the firmware
      working-directory: ./openwrt
      run: |
        echo -e "$(($(nproc)+1)) thread compile"
        
        # 设置环境变量以修复Rust LLVM问题
        export CARGO_HOME="$HOME/.cargo"
        export RUSTUP_HOME="$HOME/.rustup"
        export PATH="$CARGO_HOME/bin:$PATH"
        export RUSTFLAGS="-C linker=/usr/bin/clang"
        export CC=clang
        export CXX=clang++
        
        # 跳过Rust相关包的构建
        make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log || {
          echo "第一次编译失败，尝试跳过Rust包重新编译"
          # 从日志中提取失败的包
          if grep -q "rust" build.log; then
            echo "检测到Rust编译失败，尝试禁用Rust包"
            sed -i 's/^CONFIG_PACKAGE_rust=y/# CONFIG_PACKAGE_rust is not set/g' .config
            sed -i 's/^CONFIG_PACKAGE_rustc=y/# CONFIG_PACKAGE_rustc is not set/g' .config
            sed -i 's/^CONFIG_PACKAGE_cargo=y/# CONFIG_PACKAGE_cargo is not set/g' .config
            make defconfig
            echo "重新编译..."
            make -j$(($(nproc)+1)) V=s
          else
            # 如果不是Rust问题，尝试单线程编译
            echo "尝试单线程编译..."
            make -j1 V=s
          fi
        }

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        mkdir -p firmware
        # 复制固件文件
        find openwrt/bin/targets -type f \( -name "*combined*" -o -name "*sysupgrade*" -o -name "*rootfs*" -o -name "*kernel*" \) -exec cp {} firmware/ \;
        
        # 复制配置文件
        cp openwrt/.config firmware/openwrt.config
        echo "Build date: $(date +'%Y-%m-%d %H:%M:%S')" > firmware/build-info.txt
        echo "OpenWrt version: ${{ github.event.inputs.version }}" >> firmware/build-info.txt
        echo "Repository: https://github.com/openwrt/openwrt" >> firmware/build-info.txt
        echo "Helloworld plugin: https://github.com/fw876/helloworld" >> firmware/build-info.txt
        
        # 计算MD5
        cd firmware
        for file in *; do
          if [ -f "$file" ] && [[ "$file" != *.md5 && "$file" != *.txt && "$file" != *.config ]]; then
            md5sum "$file" > "$file.md5"
          fi
        done
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: Upload firmware directory
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_${{ github.event.inputs.version }}_${{ env.date }}
        path: ${{ env.FIRMWARE }}

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=${{ github.event.inputs.version }}-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: OpenWrt ${{ github.event.inputs.version }} Build
        body: |
          OpenWrt ${{ github.event.inputs.version }} Build
          
          Build date: $(date +'%Y-%m-%d %H:%M:%S')
          
          Source: https://github.com/openwrt/openwrt
          
          Helloworld plugin: https://github.com/fw876/helloworld
          
          This build includes only official OpenWrt sources and helloworld plugin.
        files: ${{ env.FIRMWARE }}/*

    - name: Delete workflow runs
      uses: glmghost/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.2.1
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
